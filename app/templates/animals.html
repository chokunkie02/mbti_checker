{% extends 'base.html' %}

{% block title %}MBTI Animals{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Swiper/8.4.5/swiper-bundle.min.css" />
<style>
    :root {
        --analyst-color: #BA68C8;
        --diplomat-color: #81C784;
        --guardian-color: #64B5F6;
        --explorer-color: #FFEB3B;
        --mbti-gradient: linear-gradient(135deg, var(--analyst-color), var(--diplomat-color), 
                                            var(--guardian-color), var(--explorer-color));
        --mbti-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        --mbti-bg: #f9f7ff;
        --mbti-text: #333333;
    }

    body {
        font-family: 'Prompt', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background-color: var(--mbti-bg);
        color: var(--mbti-text);
        min-height: 100vh;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
    }

    .page-header {
        text-align: center;
        margin-bottom: 4rem;
    }

    h1 {
        font-size: 3.5rem;
        margin-bottom: 1rem;
        font-weight: 800;
        background: var(--mbti-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .subtitle {
        color: #666;
        font-size: 1.3rem;
        font-weight: 300;
    }

    .current-type {
        background: white;
        border-radius: 20px;
        padding: 3rem;
        margin-bottom: 3rem;
        box-shadow: var(--mbti-shadow);
        animation: fadeIn 0.5s ease;
    }

    .animal-info {
        display: flex;
        align-items: center;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .animal-image {
        width: 200px;
        height: 200px;
        object-fit: contain;
    }

    .animal-title {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 1rem;
    }

    .animal-description {
        font-size: 1.1rem;
        line-height: 1.8;
        color: #666;
        margin-bottom: 2rem;
    }

    .trait-row {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        transition: transform 0.3s ease;
    }

    .trait-row:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }

    .trait-title {
        font-size: 1.2rem;
        font-weight: 700;
        margin-bottom: 0.8rem;
    }

    .trait-description {
        color: #666;
        line-height: 1.6;
    }

    .carousel-section {
        background: white;
        border-radius: 20px;
        padding: 3rem;
        box-shadow: var(--mbti-shadow);
        margin-top: 3rem;
    }

    .carousel-title {
        text-align: center;
        font-size: 2rem;
        margin-bottom: 2.5rem;
        font-weight: 700;
    }

    .swiper {
        padding: 30px 10px;
    }

    .swiper-slide {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        box-shadow: var(--mbti-shadow);
        transition: all 0.3s ease;
        opacity: 0.7;
        transform: scale(0.9);
        cursor: pointer;
    }

    .swiper-slide-active {
        opacity: 1;
        transform: scale(1.05);
    }

    .swiper-button-next,
    .swiper-button-prev {
        color: var(--mbti-text);
        background: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        box-shadow: var(--mbti-shadow);
    }

    .swiper-button-next:after,
    .swiper-button-prev:after {
        font-size: 1.2rem;
        font-weight: bold;
    }

    .swiper-pagination-bullet {
        background: var(--mbti-text);
        opacity: 0.5;
    }

    .swiper-pagination-bullet-active {
        opacity: 1;
        background: var(--mbti-gradient);
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 768px) {
        .container { padding: 20px 15px; }
        h1 { font-size: 2.5rem; }
        .current-type { padding: 2rem; }
        .animal-info { flex-direction: column; text-align: center; }
        .animal-image { width: 150px; height: 150px; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>MBTI Animals</h1>
        <p class="subtitle">ค้นพบสัตว์ที่เป็นตัวแทนบุคลิกภาพของคุณ</p>
    </div>

    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <div>กำลังโหลดข้อมูล...</div>
    </div>

    <div id="error-container"></div>

    <div class="current-type" id="current-type" style="display: none">
        <!-- Animal content will be loaded here -->
    </div>

    <div class="carousel-section" id="carousel-section" style="display: none">
        <h2 class="carousel-title">สัตว์ MBTI อื่นๆ</h2>
        <div class="swiper">
            <div class="swiper-wrapper" id="swiper-wrapper"></div>
            <div class="swiper-pagination"></div>
            <div class="swiper-button-next"></div>
            <div class="swiper-button-prev"></div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Swiper/8.4.5/swiper-bundle.min.js"></script>
<script>
    const jsonUrl = "https://raw.githubusercontent.com/chokunkie02/mbti_checker/refs/heads/main/app/templates/animals.json";
    let animals = [];
    let userType = null;
    let swiper;

    // Color mapping for each animal type
    const animalColors = {
        'ESFP': ["#FF9800", "#FFEB3B", "#2196F3"],  // สีส้ม, สีเหลือง, สีฟ้า
        'ESTP': ["#F44336", "#FF9800", "#212121"],  // สีแดง, สีส้ม, สีดำ
        'ISFP': ["#FFEB3B", "#212121", "#795548"],  // สีเหลือง, สีดำ, สีน้ำตาล
        'ISTP': ["#9E9E9E", "#FFFFFF", "#3F51B5"],  // สีเทา, สีขาว, สีน้ำเงิน
        'ISTJ': ["#212121", "#9E9E9E", "#BDBDBD"],  // สีดำ, สีเทา, สีเงิน
        'ESTJ': ["#FF9800", "#212121", "#FFC107"],  // สีส้ม, สีดำ, สีทอง
        'ISFJ': ["#795548", "#F5F5DC", "#4CAF50"],  // สีน้ำตาล, สีเบจ, สีเขียว
        'ESFJ': ["#D7CCC8", "#C8E6C9", "#FFFFFF"],  // สีน้ำตาลอ่อน, สีเขียวอ่อน, สีขาว
        'INFJ': ["#1B5E20", "#795548", "#212121"],  // สีเขียวเข้ม, สีน้ำตาล, สีดำ
        'ENFJ': ["#4CAF50", "#212121", "#BDBDBD"],  // สีเขียว, สีดำ, สีเงิน
        'INFP': ["#9E9E9E", "#D7CCC8", "#C8E6C9"],  // สีเทา, สีน้ำตาลอ่อน, สีเขียวอ่อน
        'ENFP': ["#FFEB3B", "#795548", "#FFFFFF"],  // สีเหลือง, สีน้ำตาล, สีขาว
        'INTJ': ["#FFC107", "#795548", "#212121"],  // สีทอง, สีน้ำตาล, สีดำ
        'ENTJ': ["#4CAF50", "#FFEB3B", "#F44336"],  // สีเขียว, สีเหลือง, สีแดง
        'INTP': ["#2196F3", "#BDBDBD", "#FFFFFF"],  // สีฟ้า, สีเงิน, สีขาว
        'ENTP': ["#9E9E9E", "#795548", "#FFFFFF"]   // สีเทา, สีน้ำตาล, สีขาว
    };

    {% if current_user.is_authenticated and current_user.mbti_type %}
        userType = '{{ current_user.mbti_type }}';
    {% else %}
        userType = localStorage.getItem('mbtiType');
    {% endif %}

    async function fetchData() {
        try {
            const response = await fetch(jsonUrl);
            if (!response.ok) throw new Error("Network response was not ok");
            animals = await response.json();
            renderApp();
        } catch (error) {
            console.error("Error fetching data:", error);
            document.getElementById('error-container').innerHTML = `
                <div class="error-message">
                    <strong>เกิดข้อผิดพลาด</strong>
                    <p>ไม่สามารถโหลดข้อมูลได้ กรุณาลองใหม่อีกครั้ง</p>
                </div>
            `;
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    function renderApp() {
        const currentAnimal = animals[0];  // Start with first animal by default
        displayCurrentType(currentAnimal);
        setupCarousel();
    }

    function displayCurrentType(animal) {
        const currentType = document.getElementById('current-type');
        const mbtiType = animal.title.split('=')[1].trim();
        const colors = animalColors[mbtiType];

        currentType.style.borderTop = `5px solid ${colors[0]}`;
        currentType.innerHTML = `
            <div class="animal-info">
                <img src="/static/mbti/${mbtiType}.png" alt="${animal.title}" class="animal-image">
                <div>
                    <h2 class="animal-title" style="color: ${colors[0]}">${animal.title}</h2>
                    <p class="animal-description">${animal.description}</p>
                </div>
            </div>
            <div class="traits-list">
                ${animal.traits.map((trait, index) => `
                    <div class="trait-row" style="border-left: 4px solid ${colors[index % colors.length]}">
                        <h3 class="trait-title" style="color: ${colors[index % colors.length]}">${trait.name}</h3>
                        <p class="trait-description">${trait.description}</p>
                    </div>
                `).join('')}
            </div>
        `;

        currentType.style.display = 'block';
    }

    function setupCarousel() {
        const wrapper = document.getElementById('swiper-wrapper');
        wrapper.innerHTML = animals.map(animal => {
            const mbtiType = animal.title.split('=')[1].trim();
            const colors = animalColors[mbtiType];
            return `
                <div class="swiper-slide" style="border-top: 4px solid ${colors[0]}">
                    <img src="/static/mbti/${mbtiType}.png" alt="${animal.title}" style="width: 100px; height: 100px; object-fit: contain; margin-bottom: 1rem;">
                    <h3 style="color: ${colors[0]}">${animal.title}</h3>
                    <p>${animal.description.substring(0, 100)}...</p>
                </div>
            `;
        }).join('');

        document.getElementById('carousel-section').style.display = 'block';

        if (swiper) swiper.destroy();

        swiper = new Swiper('.swiper', {
            slidesPerView: 3,
            spaceBetween: 30,
            centeredSlides: true,
            loop: true,
            autoplay: {
                delay: 2000,
                disableOnInteraction: false,
            },
            pagination: {
                el: '.swiper-pagination',
                clickable: true,
            },
            navigation: {
                nextEl: '.swiper-button-next',
                prevEl: '.swiper-button-prev',
            },
            breakpoints: {
                320: {
                    slidesPerView: 1,
                    spaceBetween: 20
                },
                768: {
                    slidesPerView: 2,
                    spaceBetween: 30
                },
                1024: {
                    slidesPerView: 3,
                    spaceBetween: 40
                }
            }
        });

        wrapper.querySelectorAll('.swiper-slide').forEach((slide, index) => {
            slide.addEventListener('click', () => {
                displayCurrentType(animals[index % animals.length]);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        });
    }

    fetchData();
</script>
{% endblock %}
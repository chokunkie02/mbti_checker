{% extends "base.html" %}

{% block title %}แบบทดสอบ MBTI{% endblock %}

{% block extra_css %}
<style>
    .instructions {
        background: white;
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .instructions h3 {
        margin-bottom: 15px;
        color: var(--mbti-text);
        font-weight: 600;
    }

    .instructions ul {
        list-style-type: none;
        padding-left: 0;
    }

    .instructions ul li {
        margin-bottom: 12px;
        padding-left: 25px;
        position: relative;
        color: var(--mbti-text);
    }

    .instructions ul li::before {
        content: '•';
        color: var(--mbti-purple);
        position: absolute;
        left: 8px;
        font-weight: bold;
    }

    .question-section {
        margin-bottom: 40px;
    }

    .question-section h2 {
        color: white;
        padding: 10px 20px;
        margin-bottom: 20px;
        font-size: 1.5rem;
        background: var(--mbti-gradient);
        border-radius: 8px;
        box-shadow: var(--mbti-shadow);
    }

    .question-container {
        margin-bottom: 20px;
        padding: 20px;
        border-radius: 12px;
        background: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .question-container:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }

    .options {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin-top: 15px;
    }

    .radio-option {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 8px 16px;
        border-radius: 20px;
        transition: all 0.3s ease;
        background: #f8f9fa;
    }

    .radio-option:hover {
        background: #e9ecef;
    }

    .radio-option input[type="radio"] {
        cursor: pointer;
    }

    button[type="submit"] {
        display: block;
        width: max-content;
        margin: 40px auto;
        padding: 15px 40px;
        background: var(--mbti-gradient);
        background-size: 300% 300%;
        animation: gradient-shift 5s ease infinite;
        color: white;
        border: none;
        border-radius: 30px;
        cursor: pointer;
        font-size: 1.2rem;
        font-weight: 500;
        transition: all 0.3s ease;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
    }

    @keyframes gradient-shift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    button[type="submit"]:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(108, 92, 231, 0.3);
    }

    #result {
        text-align: center;
        font-size: 24px;
        margin-top: 20px;
        padding: 20px;
        border-radius: 12px;
        background: white;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    @media (max-width: 768px) {
        .options {
            flex-direction: column;
            gap: 10px;
        }

        .radio-option {
            width: 100%;
            justify-content: center;
        }

        button[type="submit"] {
            width: 100%;
            padding: 15px 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<h1>แบบทดสอบบุคลิกภาพ MBTI</h1>

<div class="instructions">
    <h3>คำชี้แจง:</h3>
    <ul>
        <li>แบบทดสอบมีทั้งหมด 32 ข้อ</li>
        <li>กรุณาตอบทุกข้อตามความรู้สึกแรกของคุณ</li>
        <li>ไม่มีคำตอบที่ถูกหรือผิด</li>
    </ul>
</div>

<form id="mbtiForm" method="POST">
    <div class="question-section">
        <h2>ส่วนที่ 1: Extraversion (E) vs Introversion (I)</h2>
        <div id="ei-questions">
            <!-- Questions 1-8 -->
        </div>
    </div>

    <div class="question-section">
        <h2>ส่วนที่ 2: Sensing (S) vs Intuition (N)</h2>
        <div id="sn-questions">
            <!-- Questions 9-16 -->
        </div>
    </div>

    <div class="question-section">
        <h2>ส่วนที่ 3: Thinking (T) vs Feeling (F)</h2>
        <div id="tf-questions">
            <!-- Questions 17-24 -->
        </div>
    </div>

    <div class="question-section">
        <h2>ส่วนที่ 4: Judging (J) vs Perceiving (P)</h2>
        <div id="jp-questions">
            <!-- Questions 25-32 -->
        </div>
    </div>

    <input type="hidden" name="mbti_result" id="mbti_result">
    <button type="submit">ดูผลการทดสอบ</button>
</form>

<div id="result" style="display:none;"></div>
{% endblock %}

{% block extra_js %}
<script>
    const questions = {
        ei: [
            "คุณชอบพบปะผู้คนใหม่ๆ",
            "คุณรู้สึกมีพลังเมื่อได้อยู่ท่ามกลางผู้คน",
            "คุณชอบทำงานเป็นทีมมากกว่าทำงานคนเดียว",
            "คุณมักเป็นคนเริ่มบทสนทนาก่อน",
            "คุณชอบงานสังสรรค์และกิจกรรมกลุ่ม",
            "คุณแสดงความคิดเห็นออกมาได้ง่าย",
            "คุณชอบเป็นจุดสนใจของผู้อื่น",
            "คุณตัดสินใจเร็วและพร้อมลงมือทำทันที"
        ],
        sn: [
            "คุณให้ความสำคัญกับรายละเอียดมากกว่าภาพรวม",
            "คุณชอบทำตามแผนที่วางไว้มากกว่าด้นสด",
            "คุณเชื่อในประสบการณ์จริงมากกว่าทฤษฎี",
            "คุณชอบงานที่เป็นรูปธรรมจับต้องได้",
            "คุณสนใจเรื่องในปัจจุบันมากกว่าอนาคต",
            "คุณชอบวิธีการแก้ปัญหาแบบดั้งเดิมที่พิสูจน์แล้ว",
            "คุณตัดสินใจโดยใช้ข้อมูลจริงมากกว่าสัญชาตญาณ",
            "คุณชอบเรียนรู้ทักษะใหม่ทีละขั้นตอน"
        ],
        tf: [
            "คุณตัดสินใจด้วยเหตุผลมากกว่าความรู้สึก",
            "คุณชอบวิเคราะห์ปัญหาอย่างเป็นระบบ",
            "คุณให้ความสำคัญกับความถูกต้องมากกว่าความสามัคคี",
            "คุณมักวิจารณ์ความคิดผู้อื่นอย่างตรงไปตรงมา",
            "คุณชอบความยุติธรรมมากกว่าความเห็นอกเห็นใจ",
            "คุณตัดสินใจโดยไม่คำนึงถึงความรู้สึกคนอื่น",
            "คุณชอบถกเถียงด้วยเหตุผล",
            "คุณเน้นความสำเร็จของงานมากกว่าความสัมพันธ์"
        ],
        jp: [
            "คุณชอบวางแผนล่วงหน้าเสมอ",
            "คุณทำงานเป็นระบบและมีขั้นตอน",
            "คุณชอบจัดตารางเวลาที่แน่นอน",
            "คุณทำงานให้เสร็จก่อนกำหนดเสมอ",
            "คุณชอบความเป็นระเบียบเรียบร้อย",
            "คุณรู้สึกไม่สบายใจเมื่อมีการเปลี่ยนแปลงกะทันหัน",
            "คุณชอบทำงานให้เสร็จทีละอย่าง",
            "คุณต้องการความชัดเจนในทุกสถานการณ์"
        ]
    };

    function createQuestions(section, questions) {
        const container = document.getElementById(`${section}-questions`);
        questions.forEach((question, index) => {
            const questionNumber = index + (section === 'ei' ? 1 : 
                                       section === 'sn' ? 9 : 
                                       section === 'tf' ? 17 : 25);
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-container';
            questionDiv.innerHTML = `
                <div>${questionNumber}. ${question}</div>
                <div class="options">
                    <label class="radio-option">
                        <input type="radio" name="q${questionNumber}" value="yes" required>
                        ใช่
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="q${questionNumber}" value="neutral">
                        กลางๆ
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="q${questionNumber}" value="no">
                        ไม่ใช่
                    </label>
                </div>
            `;
            container.appendChild(questionDiv);
        });
    }

    function calculateResult(answers, start, end) {
        let score = 0;
        for (let i = start; i <= end; i++) {
            if (answers[`q${i}`] === 'yes') score++;
            if (answers[`q${i}`] === 'no') score--;
        }
        return score;
    }

    document.getElementById('mbtiForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const answers = Object.fromEntries(formData.entries());

        const ei = calculateResult(answers, 1, 8);
        const sn = calculateResult(answers, 9, 16);
        const tf = calculateResult(answers, 17, 24);
        const jp = calculateResult(answers, 25, 32);

        const result = `${ei >= 0 ? 'E' : 'I'}${sn >= 0 ? 'S' : 'N'}${tf >= 0 ? 'T' : 'F'}${jp >= 0 ? 'J' : 'P'}`;

        const isLoggedIn = {{ 'true' if current_user.is_authenticated else 'false' }};

        if (isLoggedIn) {
            fetch('/save_mbti', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ mbti_result: result }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    localStorage.setItem('hasTakenQuiz', 'true');
                    localStorage.setItem('mbtiType', result);
                    window.location.href = '/result';
                } else {
                    alert('เกิดข้อผิดพลาดในการบันทึกผลลัพธ์');
                }
            });
        } else {
            localStorage.setItem('mbtiType', result);
            localStorage.setItem('hasTakenQuiz', 'true');
            window.location.href = '/result';
        }
    });

    // Initialize questions
    Object.entries(questions).forEach(([section, questionList]) => {
        createQuestions(section, questionList);
    });
</script>
{% endblock %}